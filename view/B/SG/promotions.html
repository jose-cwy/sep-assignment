<script src="../checkCountry.js"></script>
<html>

<head>
  <title>Promotions</title>
  <script src="../../header.js"></script>
</head>

<style>
  .promo-grid{
    display:flex;
    flex-wrap:wrap;
    justify-content:center; 
    padding-left:0;
    margin-left:-3%;
  }

  .promo-grid > li{
    float:none !important;
    display:flex;
  }

  .promo-grid .product-thumb-info{
    width:100%;
    display:flex;
    flex-direction:column;
    height:100%;
  }

  .promo-grid .product-thumb-info-image img{
    width:100%;
    height:160px;   
    object-fit:cover;
    display:block;
  }

  .promo-grid .product-thumb-info-content{
    display:flex;
    flex-direction:column;
    flex:1;
  }

  .promo-grid .product-thumb-info-content .btn{
    margin-top:auto;
  }
</style>

<body>
  <script src="menu2.js"></script>

  <div class="body">
    <div role="main" class="main">

      <section class="page-top">
        <div class="container">
          <div class="row">
            <div class="col-md-12">
              <h2>Promotions</h2>
            </div>
          </div>
        </div>
      </section>

      <div class="container">

        <!-- TOP PROMOS (20% and 30%) -->
        <div class="row">
          <div class="col-md-12">
            <h3 style="margin-top:10px;">Top Promotions</h3>
            <hr class="tall" style="margin:10px 0 15px;">
          </div>

          <ul id="topPromotionDisplay" class="products product-thumb-info-list promo-grid"
            style="list-style-type:none; margin-left:-3%;"></ul>
        </div>

        <!-- OTHER PROMOS (10%) -->
        <div class="row" style="margin-top:30px;">
          <div class="col-md-12">
            <h3>Other Promotions</h3>
            <hr class="tall" style="margin:10px 0 15px;">
          </div>

          <ul id="otherPromotionDisplay" class="products product-thumb-info-list promo-grid"
            style="list-style-type:none; margin-left:-3%;"></ul>
        </div>
        <hr class="tall">
      </div>

    </div>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", function () {
  var countryPrefix = localStorage.getItem("urlPrefix");
  var countryId = localStorage.getItem("countryId");

  var topList = document.getElementById("topPromotionDisplay");
  var otherList = document.getElementById("otherPromotionDisplay");

  function toPromoImg(rawImg) {
    if (!rawImg) return "../../img/promotions/F_CH_73.jpg";
    var filename = rawImg.toString().split("/").pop();
    return "../../img/promotions/" + filename;
  }

  function renderPromo(promo) {
    var id = promo.id || promo.ID;
    var desc = promo.description || promo.DESCRIPTION || "";
    var rate = promo.discountRate || promo.DISCOUNTRATE || "";
    var start = (promo.startDate || promo.STARTDATE || "").toString().substring(0, 10);
    var end = (promo.endDate || promo.ENDDATE || "").toString().substring(0, 10);
    var img = toPromoImg(promo.imageURL || promo.IMAGEURL);

    var detailsUrl = "/B/" + countryPrefix + "/promotionDetails.html?id=" + encodeURIComponent(id);

    return `
      <li class="col-md-3 col-sm-6 col-xs-12 product" style="padding-bottom:1%; padding-top:2%;">
        <span class="product-thumb-info">
          <span class="product-thumb-info-image">
            <a href="${detailsUrl}">
              <img class="img-responsive" src="${img}" alt="">
            </a>
          </span>
          <span class="product-thumb-info-content">
            <h4>${desc}</h4>
            <em>${rate}% OFF</em><br/>
            <em>${start} â†’ ${end}</em><br/><br/>
            <a href="${detailsUrl}" class="btn btn-primary btn-block">More Details</a>
          </span>
        </span>
      </li>
    `;
  }

  fetch("/api/getPromotionsByCountry?countryId=" + encodeURIComponent(countryId))
    .then(res => res.json())
    .then(data => {

      if (!data || data.length === 0) {
        topList.innerHTML = "<p>No promotions available.</p>";
        otherList.innerHTML = "<p>No other promotions.</p>";
        return;
      }

      var topHTML = "";
      var otherHTML = "";

      data.forEach(function (promo) {
        var desc = (promo.description || promo.DESCRIPTION || "").toLowerCase();

        if (
          desc.includes("january") ||
          desc.includes("new year")
        ) {
          topHTML += renderPromo(promo);
        }
        else if (
          desc.includes("annivasary")
        ) {
          otherHTML += renderPromo(promo);
        }
      });

      topList.innerHTML = topHTML || "<p>No top promotions.</p>";
      otherList.innerHTML = otherHTML || "<p>No other promotions right now.</p>";
    })
    .catch(err => {
      console.error(err);
      topList.innerHTML = "<p>Error loading promotions.</p>";
      otherList.innerHTML = "";
    });
});
</script>

<script src="../footer.js"></script>
</body>

</html>